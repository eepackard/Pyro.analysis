---
title: "pyro.functional.guilds.aug9.2021"
output:
  word_document: default
  html_document: default
---

```{python}
## To run funguild from terminal need to have download the python script from https://github.com/UMNFuN/FUNGuild. 
## ASV table must be transformed to fit the required format: Samples as columns and taxa as rows, first column must be "OTU_ID" followed by OTU_#, first column after samples must be "taxonomy" with taxonomic names listed with ";" seperators between taxonomic levels. 
## Once formated taxonomic/species file and python script are in same directory can run script 

#first make sure requests is installed 
pip3 install requests 

#run command
python3.9 Guilds_v1.1.py -otu spring.species.filtered.FUNGuild.aug6.2021.txt -db fungi -m -u
```

##read in packages
```{r}
library(readr)
library(car)
library(dplyr)
library(tidyr)
library(reshape2)
library(ggplot2)
library(visreg)
library(ggpubr)
library(emmeans)
```


##import results from funguild
```{r}
FUNGuild.spring <- read_delim("spring.species.filtered.FUNGuild.aug6.2021.guilds_matched.txt","\t", escape_double = FALSE, trim_ws = TRUE)

FUNGuild.fall<-read_delim("OTU.formatted.fungild.guilds_matched.txt","\t",escape_double = FALSE,trim_ws = TRUE)
```

##first remove any classifications that are classified as "possible"
```{r}
FUNGuild.fall$`Confidence Ranking` <-as.factor(FUNGuild.fall$`Confidence Ranking`)
levels(FUNGuild.fall$`Confidence Ranking`)

FUNGuild.spring$`Confidence Ranking` <-as.factor(FUNGuild.spring$`Confidence Ranking`)
levels(FUNGuild.spring$`Confidence Ranking`)

FUNGuild.fall.1<-FUNGuild.fall[-which(FUNGuild.fall$`Confidence Ranking` == "Possible"),]
FUNGuild.spring.1<-FUNGuild.spring[-which(FUNGuild.spring$`Confidence Ranking` == "Possible"),]

```

## combine guilds into more susicnet categories
```{r}
FUNGuild.fall.1$Guild<-as.factor(FUNGuild.fall.1$Guild)
levels(FUNGuild.fall.1$Guild)
FUNGuild.fall.1$`Trophic Mode`<-as.factor(FUNGuild.fall.1$`Trophic Mode`)
levels(FUNGuild.fall.1$`Trophic Mode`)
FUNGuild.spring.1$Guild<-as.factor(FUNGuild.spring.1$Guild)
levels(FUNGuild.spring.1$Guild)
FUNGuild.spring.1$`Trophic Mode`<-as.factor(FUNGuild.spring.1$`Trophic Mode`)
levels(FUNGuild.spring.1$`Trophic Mode`)

##4: use trophic mode, except breakdown symbiotroph into more specific categories... ----
##spring
## create subsetted dataframe with only symbiotroph 
symbio.breakdown<-dplyr::filter(FUNGuild.spring.1,FUNGuild.spring.1$`Trophic Mode`=="Symbiotroph")
#create dataframe with every other option
other.breakdown<-dplyr::filter(FUNGuild.spring.1,FUNGuild.spring.1$`Trophic Mode`!="Symbiotroph")
symbio.breakdown$Guild<-as.factor(symbio.breakdown$Guild)
levels(symbio.breakdown$Guild)

#breakdown symbiotroph into "other mycorrhiza", "ectomycorrhiza", and everything else into "symbiotroph"
symbio.breakdown$Guild.2 = as.factor(
    ifelse(symbio.breakdown$Guild %in% c('Arbuscular Mycorrhizal','Orchid Mycorrhizal'),
        'Arbusular/Orchid Mycorrhizal',
        ifelse(symbio.breakdown$Guild %in% c('Endophyte','Epiphyte','Lichenized','Lichenized-Wood Saprotroph'),
            'Symbiotroph',as.character(symbio.breakdown$Guild))))

##create subset of all other modes that contain a guild with ectomycorrhizal 
other.ecto.breakdown<-dplyr::filter(other.breakdown,grepl(pattern='Ectomycorrhizal', Guild))
opposite.ecto.breakdown<-dplyr::filter(other.breakdown,!grepl(pattern='Ectomycorrhizal', Guild))
other.ecto.breakdown$Guild.2<-other.ecto.breakdown$`Trophic Mode`
opposite.ecto.breakdown$Guild.2<-opposite.ecto.breakdown$`Trophic Mode`

other.ecto.breakdown$Guild.2 = as.factor(
    ifelse(other.ecto.breakdown$Guild.2 == "Pathotroph-Symbiotroph",
        'Pathotroph-Ectomycorrhizal','Saprotroph-Ectomycorrhizal'))

##rebuild dataframes together 
Funguild.spring.3<-rbind(symbio.breakdown,other.ecto.breakdown,opposite.ecto.breakdown)
#confrim we have kept all rows
length(Funguild.spring.3$Guild) 
##^ back to 494 rows 
is.factor(Funguild.spring.3$Guild.2)
levels(Funguild.spring.3$Guild.2)

##fall
## create subsetted dataframe with only symbiotroph 
symbio.breakdown.fall<-dplyr::filter(FUNGuild.fall.1,FUNGuild.fall.1$`Trophic Mode`=="Symbiotroph")
#create dataframe with every other option
other.breakdown.fall<-dplyr::filter(FUNGuild.fall.1,FUNGuild.fall.1$`Trophic Mode`!="Symbiotroph")
symbio.breakdown.fall$Guild<-as.factor(symbio.breakdown.fall$Guild)


#breakdown symbiotroph into "other mycorrhiza", "ectomycorrhiza", and everything else into "symbiotroph"
symbio.breakdown.fall$Guild.2 = as.factor(
    ifelse(symbio.breakdown.fall$Guild %in% c('Arbuscular Mycorrhizal','Orchid Mycorrhizal'),
        'Arbusular/Orchid Mycorrhizal',
        ifelse(symbio.breakdown.fall$Guild %in% c('Endophyte','Epiphyte','Lichenized','Lichenized-Wood Saprotroph'),
            'Symbiotroph',as.character(symbio.breakdown.fall$Guild))))

##create subset of all other modes that contain a guild with ectomycorrhizal 
other.ecto.breakdown.fall<-dplyr::filter(other.breakdown.fall,grepl(pattern='Ectomycorrhizal', Guild))
opposite.ecto.breakdown.fall<-dplyr::filter(other.breakdown.fall,!grepl(pattern='Ectomycorrhizal', Guild))
other.ecto.breakdown.fall$Guild.2<-other.ecto.breakdown.fall$`Trophic Mode`
opposite.ecto.breakdown.fall$Guild.2<-opposite.ecto.breakdown.fall$`Trophic Mode`
other.ecto.breakdown.fall$Guild.2 = as.factor(
    ifelse(other.ecto.breakdown.fall$Guild.2 == "Pathotroph-Symbiotroph",
        'Pathotroph-Ectomycorrhizal','Saprotroph-Ectomycorrhizal'))

##rebuild dataframes together 
Funguild.fall.3<-rbind(symbio.breakdown.fall,other.ecto.breakdown.fall,opposite.ecto.breakdown.fall)
#confrim we have kept all rows
length(Funguild.fall.3$Guild) 
##^ back to 246 rows 
is.factor(Funguild.spring.3$Guild.2)
levels(Funguild.spring.3$Guild.2)

```

##read in metadata 
```{r}
##spring----
##data output from qiime2 viewer at species level - assigned to order or lower features with 10 or less across all samples removed
spring_species_filtered_aug16_2021 <- read_csv("spring.species.aug16.2021.csv")
samplenames<-spring_species_filtered_aug16_2021$index
spring_species_filtered_aug16_2021<-as.data.frame(spring_species_filtered_aug16_2021[,2:789])
row.names(spring_species_filtered_aug16_2021)<-samplenames
View(spring_species_filtered_aug16_2021)

#substract reads that were present in the negative control
asv.spring_species.filtered_aug16_2021<-as.data.frame(t(spring_species_filtered_aug16_2021))
which(asv.spring_species.filtered_aug16_2021$neg > 0) ## determine which ASVs the negative has reads in

spring_species_filtered_aug16_2021[,52]<-spring_species_filtered_aug16_2021[,52]-2 #remove the same number of reads from every sample
spring_species_filtered_aug16_2021[,52]<-ifelse(spring_species_filtered_aug16_2021[,52]<0,0,as.numeric(spring_species_filtered_aug16_2021$`k__Fungi;p__Ascomycota;c__Dothideomycetes;o__Pleosporales;f__Didymellaceae;g__Didymella;s__Didymella_exigua`)) #ensure no ASVs had a negative number of reads

#repeat with other ASV
spring_species_filtered_aug16_2021[,314]<-spring_species_filtered_aug16_2021[,314]-4
spring_species_filtered_aug16_2021[,314]<-ifelse(spring_species_filtered_aug16_2021[,314]<0,0,as.numeric(spring_species_filtered_aug16_2021$`k__Fungi;p__Ascomycota;c__Pezizomycetes;o__Pezizales;f__Pyronemataceae;g__Geopyxis;s__Geopyxis_carbonaria`))

row.names(spring_species_filtered_aug16_2021)<-samplenames #rename the rows

asv.spring_species.filtered_aug16_2021<-as.data.frame(t(spring_species_filtered_aug16_2021))
which(asv.spring_species.filtered_aug16_2021$neg > 0) ## check that it worked (note rows 786,787,788 are just meta not error)

##seperate out the metadata: sample-type, sample-date, severity
meta.data.spring<-spring_species_filtered_aug16_2021[,786:788]
meta.data.microplots.spring<-spring_species_filtered_aug16_2021[c(1:37,46:94),786:788]
samplenames.microplots<-samplenames[c(1:37,46:94)]
rownames(meta.data.microplots.spring)<-samplenames.microplots

##reorder severity levels 
meta.data.microplots.spring$Severity<-ordered(meta.data.microplots.spring$Severity,levels=c("unburnt","surface","medium","med-severe","severe","lp-severe"))
meta.data.microplots.spring$sample_date<-ordered(meta.data.microplots.spring$sample_date,levels=c("sept","oct","may","june"))

#rename factors 
meta.data.microplots.spring$Severity <- factor(meta.data.microplots.spring$Severity, labels = c("Unburnt","Low","Medium","Medium-Severe","Severe","LP-Severe"))
levels(meta.data.microplots.spring$Severity)
meta.data.microplots.spring$sample_date <- factor(meta.data.microplots.spring$sample_date, labels = c("September","October","May","June"))
levels(meta.data.microplots.spring$sample_date)
meta.data.microplots.spring$sample_type<-factor(meta.data.microplots.spring$sample_type,labels = c("Mineral","Surface"))
levels(meta.data.microplots.spring$sample_type)

View(meta.data.microplots.spring)

###Fall----
Taxa <- read_csv("Tax-order-100-taxa.csv .csv")
samplenames.fall<-Taxa$index
Taxa<-as.data.frame(Taxa[,2:ncol(Taxa)])
row.names(Taxa)<-samplenames.fall
Taxa<-Taxa[-42,]
View(Taxa)

#seperate out the metadata: sample-type, sample-date, severity
meta.data.fall<-Taxa[,362:363]
meta.data.fall<-separate(meta.data.fall,col="sample-type",into=c("sample_type","sample_date"),sep="-")
meta.data.microplots.fall<-meta.data.fall[c(1:27,31:61),]
colnames(meta.data.fall)<-c("sample_type","sample_date","Severity")
colnames(meta.data.microplots.fall)<-c("sample_type","sample_date","Severity")
View(meta.data.microplots.fall)

#order
meta.data.microplots.fall$Severity<-ordered(meta.data.microplots.fall$Severity,levels=c("unburnt","surface","medium","med-severe","severe"))
meta.data.microplots.fall$sample_date<-ordered(meta.data.microplots.fall$sample_date,levels=c("sept","oct"))

#rename factors 
meta.data.microplots.fall$Severity <- factor(meta.data.microplots.fall$Severity, labels = c("Unburnt","Low","Medium","Medium-Severe","Severe"))
levels(meta.data.microplots.fall$Severity)
meta.data.microplots.fall$sample_date <- factor(meta.data.microplots.fall$sample_date, labels = c("September","October"))
levels(meta.data.microplots.fall$sample_date)
meta.data.microplots.fall$sample_type<-factor(meta.data.microplots.fall$sample_type,labels = c("Mineral","Surface"))
levels(meta.data.microplots.fall$sample_type)

```

##create merged datset spring and fall for filtering type 4
```{r}
##combine spring and fall then split into organic and mineral for the #3 filtering option
guild.df.spring.3<-aggregate(Funguild.spring.3[,c(2:38,47:95)], Funguild.spring.3["Guild.2"],FUN=sum)
guild.df.spring.3<-t(guild.df.spring.3)
colnames(guild.df.spring.3)<-guild.df.spring.3[1,]
guild.df.spring.3<-as.data.frame(guild.df.spring.3[-1,])
guild.df.spring.3<-lapply(guild.df.spring.3,as.numeric)
guild.df.spring.3<-cbind(guild.df.spring.3,meta.data.microplots.spring)

guild.df.fall.3<-aggregate(Funguild.fall.3[,c(2:28,32:42,44:63)], Funguild.fall.3["Guild.2"],FUN=sum)
guild.df.fall.3<-t(guild.df.fall.3)
colnames(guild.df.fall.3)<-guild.df.fall.3[1,]
guild.df.fall.3<-as.data.frame(guild.df.fall.3[-1,])
guild.df.fall.3<-lapply(guild.df.fall.3,as.numeric)
guild.df.fall.3<-cbind(guild.df.fall.3,meta.data.microplots.fall)

#merge fall and spring data sets
colnames(guild.df.fall.3)
colnames(guild.df.spring.3)

guild.df.3<-rbind(guild.df.fall.3,guild.df.spring.3)

#rename columns to abbreviations for plotting 
names(guild.df.3)[names(guild.df.3) == "Ectomycorrhizal"] <- "E"
names(guild.df.3)[names(guild.df.3) == "Symbiotroph"] <- "Sy"
names(guild.df.3)[names(guild.df.3) == "Pathotroph-Ectomycorrhizal"] <- "P-E"
names(guild.df.3)[names(guild.df.3) == "Saprotroph-Ectomycorrhizal"] <- "Sp-E"
names(guild.df.3)[names(guild.df.3) == "Pathotroph"] <- "P"
names(guild.df.3)[names(guild.df.3) == "Pathotroph-Saprotroph"] <- "P-Sp"
names(guild.df.3)[names(guild.df.3) == "Pathotroph-Saprotroph-Symbiotroph"] <- "P-Sp-Sy"
names(guild.df.3)[names(guild.df.3) == "Pathotroph-Symbiotroph"] <- "P-Sy"
names(guild.df.3)[names(guild.df.3) == "Saprotroph-Symbiotroph"] <- "Sp-Sy"
names(guild.df.3)[names(guild.df.3) == "Saprotroph"] <- "Sp"

#seperate based on sample-type
guild.df.mineral.3<-dplyr::filter(guild.df.3, sample_type == "Mineral")
guild.df.organic.3<-dplyr::filter(guild.df.3, sample_type=="Surface")

meta.data.microplots.mineral<-subset(meta.data.microplots, sample_type =="Mineral")
meta.data.microplots.organic<-subset(meta.data.microplots, sample_type =="Surface")
```


#plot reltive abundance type 4
```{r}
#convert to relative abundance for guilds
guild.df.mineral.relabun.3<-guild.df.mineral.3[,1:11]/rowSums(guild.df.mineral.3[,1:11])
guild.df.mineral.relabun.3<-cbind(guild.df.mineral.relabun.3[1:64,],meta.data.microplots.mineral)

guild.df.organic.relabun.3<-guild.df.organic.3[,1:11]/rowSums(guild.df.organic.3[,1:11])
guild.df.organic.relabun.3<-cbind(guild.df.organic.relabun.3[1:64,],meta.data.microplots.organic)

guild.mineral.long.3 <- melt(guild.df.mineral.relabun.3[,1:12], id.vars = "Severity", variable.name = "Guild")
guild.mineral.long.3$Severity<-ordered(guild.mineral.long.3$Severity,levels=c("Unburnt","Low","Medium","Medium-Severe","Severe","LP-Severe"))

guild.organic.long.3 <- melt(guild.df.organic.relabun.3[,1:12], id.vars = "Severity", variable.name = "Guild")
guild.organic.long.3$Severity<-ordered(guild.organic.long.3$Severity,levels=c("Unburnt","Low","Medium","Medium-Severe","Severe","LP-Severe"))

#plot guild
guild.m.bar.3<-ggplot(guild.mineral.long.3, aes(x = Severity, y = value, fill = `Guild`)) + 
    geom_bar(stat = "identity")
guild.o.bar.3<-ggplot(guild.organic.long.3, aes(x = Severity, y = value, fill = `Guild`)) + 
    geom_bar(stat = "identity")

ggarrange(guild.m.bar.3,guild.o.bar.3,common.legend = TRUE)
```
##ordinate the type 4 
```{r}
#create function for ellipses 
veganCovEllipse <- function (cov, center = c(0, 0), scale = 1, npoints = 100) 
{
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}


#create phyloseq object
phylo.gui.min.otu.3<-otu_table(guild.df.mineral.3[,2:11],taxa_are_rows = FALSE)
phylo.gui.min.meta.3<-sample_data(guild.df.mineral.3[,12:14])
sample_names(phylo.gui.min.meta.3)

phylo.gui.mineral.3<-phyloseq(phylo.gui.min.otu.3,phylo.gui.min.meta.3)
phylo.gui.mineral.3
phylo.gui.mineral.3<-subset_samples(phylo.gui.mineral.3, Severity != "LP-Severe")

set.seed(14)
#ordinate
gui.min.3<-ordinate(phylo.gui.mineral.3,method = "NMDS",distance = "bray")
gui.min.3$stress
plot_ordination(phylo.gui.mineral.3,gui.min.3,color = "Severity",shape = "sample_date")+theme_classic()

#fit the site data
gui.min.spp.fit <- envfit(gui.min.3, guild.df.mineral.3[1:64,2:11], permutations = 999) ##1:64 excludes LP-severe, 2:11 excludes arb/orch
gui.min.site.scrs <- as.data.frame(scores(gui.min.3, display = "sites")) #save NMDS results into dataframe
gui.min.site.scrs <- cbind(gui.min.site.scrs, Severity = guild.df.mineral.3[1:64,]$Severity) #add grouping variable "Severity" to dataframe
gui.min.site.scrs <- cbind(gui.min.site.scrs, Sample_Date = guild.df.mineral.3[1:64,]$sample_date) #add grouping variable of cluster grouping to dataframe
gui.min.site.scrs <- cbind(gui.min.site.scrs, Site = rownames(guild.df.mineral.3[1:64,])) #add site names as variable if you want to display on plot
head(gui.min.site.scrs)

#fit species scores
gui.min.spp.scrs <- as.data.frame(scores(gui.min.spp.fit, display = "vectors")) #save species intrinsic values into dataframe
gui.min.spp.scrs <- cbind(gui.min.spp.scrs, Species = rownames(gui.min.spp.scrs)) #add species names to dataframe
gui.min.spp.scrs <- cbind(gui.min.spp.scrs, pval = gui.min.spp.fit$vectors$pvals) #add pvalues to dataframe so you can select species which are significant
#gui.min.spp.scrs<- cbind(gui.min.spp.scrs, abrev = abbreviate(gui.min.spp.scrs$Species, minlength = 2)) #abbreviate species names
gui.min.sig.spp.scrs <- subset(gui.min.spp.scrs, pval<=0.05) #subset data to show species significant at 0.05

head(gui.min.spp.scrs)

##now data for ellipse

df_ell.gui.min.sev <- data.frame() #sets up a data frame before running the function.
for(g in levels(gui.min.site.scrs$Severity)){
  df_ell.gui.min.sev <- rbind(df_ell.gui.min.sev, cbind(as.data.frame(with(gui.min.site.scrs [gui.min.site.scrs$Severity==g,],
                                                         veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2))))) ,Severity=g))
}
NMDS.mean.gui.min=aggregate(gui.min.site.scrs[ ,c("NMDS1", "NMDS2")], 
                         list(group = gui.min.site.scrs$Severity), mean)

#plot
nmds.plot.gui.min <- ggplot(gui.min.site.scrs, aes(x=NMDS1, y=NMDS2))+ #sets up the plot
  geom_point(aes(NMDS1, NMDS2, colour = factor(gui.min.site.scrs$Severity), shape = factor(gui.min.site.scrs$Sample_Date),fill = factor(gui.min.site.scrs$Severity)), size = 2)+ 
  coord_fixed()+
  theme_classic()+ 
  theme(panel.background = element_rect(fill = NA, colour = "black", size = 1, linetype = "solid"))+
  labs(colour = "Severity", shape = "Sample_Date")+ 
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10))+ geom_path(data = df_ell.gui.min.sev, aes(x = NMDS1, y = NMDS2,group=Severity,color=Severity))+ theme(axis.text.x = element_blank(),axis.text.y = element_blank(),axis.ticks = element_blank())+scale_color_manual(values = c("cornflowerblue","chocolate","orange1","firebrick3","tomato4","black"))+ scale_fill_manual(values = c("cornflowerblue","lightgoldenrod1","orange1","firebrick3","tomato4","black"))+scale_shape_manual(values = c(21,22,23,24))+geom_segment(data = gui.min.sig.spp.scrs, aes(x = 0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd=0.4) + #add vector arrows of significant species
  ggrepel::geom_text_repel(data = gui.min.sig.spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3.5, direction = "both", segment.size = 0.25)


nmds.plot.gui.min

#first turn into phyloseq object
phylo.gui.org.otu.3<-otu_table(guild.df.organic.3[,2:11],taxa_are_rows = FALSE)
phylo.gui.org.meta.3<-sample_data(guild.df.organic.3[,12:14])

phylo.gui.orgeral.3<-phyloseq(phylo.gui.org.otu.3,phylo.gui.org.meta.3)
phylo.gui.orgeral.3
phylo.gui.orgeral.3<-subset_samples(phylo.gui.orgeral.3, Severity != "LP-Severe")

set.seed(26)
#ordinate nmds
gui.org.3<-ordinate(phylo.gui.orgeral.3,method = "NMDS",distance = "bray",trymax=100)
gui.org.3$stress
plot_ordination(phylo.gui.orgeral.3,gui.org.3,color = "Severity",shape = "sample_date")+theme_classic()

#fit the site data
gui.org.site.scrs <- as.data.frame(scores(gui.org.3, display = "sites")) #save NMDS results into dataframe
gui.org.site.scrs <- cbind(gui.org.site.scrs, Severity = guild.df.organic.3[1:64,]$Severity) #add grouping variable "Management" to dataframe
gui.org.site.scrs <- cbind(gui.org.site.scrs, Sample_Date = guild.df.organic.3[1:64,]$sample_date) #add grouping variable of cluster grouping to dataframe
gui.org.site.scrs <- cbind(gui.org.site.scrs, Site = rownames(guild.df.organic.3[1:64,])) #add site names as variable if you want to display on plot
head(gui.org.site.scrs)

#fit species scores
gui.org.spp.fit <- envfit(gui.org.3, guild.df.organic.3[1:64,2:11], permutations = 999)
gui.org.spp.scrs <- as.data.frame(scores(gui.org.spp.fit, display = "vectors")) #save species intrinsic values into dataframe
gui.org.spp.scrs <- cbind(gui.org.spp.scrs, Species = rownames(gui.org.spp.scrs)) #add species names to dataframe
gui.org.spp.scrs <- cbind(gui.org.spp.scrs, pval = gui.org.spp.fit$vectors$pvals) #add pvalues to dataframe so you can select species which are significant
#gui.org.spp.scrs<- cbind(gui.org.spp.scrs, abrev = abbreviate(gui.org.spp.scrs$Species, minlength = 2)) #abbreviate species names
gui.org.sig.spp.scrs <- subset(gui.org.spp.scrs, pval<=0.05) #subset data to show species significant at 0.05

gui.org.sig.spp.scrs

##now the org data for ellipse
df_ell.gui.org.sev <- data.frame() #sets up a data frame before running the function.
for(g in levels(gui.org.site.scrs$Severity)){
  df_ell.gui.org.sev <- rbind(df_ell.gui.org.sev, cbind(as.data.frame(with(gui.org.site.scrs [gui.org.site.scrs$Severity==g,],
                                                         veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2))))) ,Severity=g))
}
NMDS.mean.gui.org=aggregate(gui.org.site.scrs[ ,c("NMDS1", "NMDS2")], 
                         list(group = gui.org.site.scrs$Severity), mean)


nmds.plot.gui.org <- ggplot(gui.org.site.scrs, aes(x=NMDS1, y=NMDS2))+ #sets up the plot
  geom_point(aes(NMDS1, NMDS2, colour = factor(gui.org.site.scrs$Severity), shape = factor(gui.org.site.scrs$Sample_Date),fill = factor(gui.org.site.scrs$Severity)), size = 2)+ 
  coord_fixed()+
  theme_classic()+ 
  theme(panel.background = element_rect(fill = NA, colour = "black", size = 1, linetype = "solid"))+
  labs(colour = "Severity", shape = "Sample_Date")+ 
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10))+ geom_path(data = df_ell.gui.org.sev, aes(x = NMDS1, y = NMDS2, group = Severity,colour=Severity))+ theme(axis.text.x = element_blank(),axis.text.y = element_blank(),axis.ticks = element_blank())+scale_color_manual(values = c("cornflowerblue","chocolate","orange1","firebrick3","tomato4","black"))+ scale_fill_manual(values = c("cornflowerblue","lightgoldenrod1","orange1","firebrick3","tomato4","black"))+scale_shape_manual(values = c(21,22,23,24))+geom_segment(data = gui.org.sig.spp.scrs, aes(x = 0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd=0.3) + #add vector arrows of significant species
  ggrepel::geom_text_repel(data = gui.org.sig.spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25)+geom_text(aes(label=rownames(gui.org.site.scrs)),hjust=0, vjust=0)

nmds.plot.gui.org

##upon inspecting O9A and O5G they only had 2 reads which where match to functional guild so I will remove from multivariate analysis --> rows 30 & 56

phylo.gui.org.otu.3<-otu_table(guild.df.organic.3[-c(30,56),2:11],taxa_are_rows = FALSE)
phylo.gui.org.meta.3<-sample_data(guild.df.organic.3[-c(30,56),12:14])

phylo.gui.orgeral.3<-phyloseq(phylo.gui.org.otu.3,phylo.gui.org.meta.3)
phylo.gui.orgeral.3
phylo.gui.orgeral.3<-subset_samples(phylo.gui.orgeral.3, Severity != "LP-Severe")

set.seed(26)
#ordinate nmds
gui.org.3<-ordinate(phylo.gui.orgeral.3,method = "NMDS",distance = "bray",trymax=100)
gui.org.3$stress


#fit the site data
gui.org.site.scrs <- as.data.frame(scores(gui.org.3, display = "sites")) #save NMDS results into dataframe
gui.org.site.scrs <- cbind(gui.org.site.scrs, Severity = guild.df.organic.3[c(1:29,31:55,57:64),]$Severity) #add grouping variable "Management" to dataframe
gui.org.site.scrs <- cbind(gui.org.site.scrs, Sample_Date = guild.df.organic.3[c(1:29,31:55,57:64),]$sample_date) #add grouping variable of cluster grouping to dataframe
gui.org.site.scrs <- cbind(gui.org.site.scrs, Site = rownames(guild.df.organic.3[c(1:29,31:55,57:64),])) #add site names as variable if you want to display on plot
head(gui.org.site.scrs)

#fit species scores
gui.org.spp.fit <- envfit(gui.org.3, guild.df.organic.3[c(1:29,31:55,57:64),2:11], permutations = 999)
gui.org.spp.scrs <- as.data.frame(scores(gui.org.spp.fit, display = "vectors")) #save species intrinsic values into dataframe
gui.org.spp.scrs <- cbind(gui.org.spp.scrs, Species = rownames(gui.org.spp.scrs)) #add species names to dataframe
gui.org.spp.scrs <- cbind(gui.org.spp.scrs, pval = gui.org.spp.fit$vectors$pvals) #add pvalues to dataframe so you can select species which are significant
#gui.org.spp.scrs<- cbind(gui.org.spp.scrs, abrev = abbreviate(gui.org.spp.scrs$Species, minlength = 2)) #abbreviate species names
gui.org.sig.spp.scrs <- subset(gui.org.spp.scrs, pval<=0.05) #subset data to show species significant at 0.05

gui.org.sig.spp.scrs

##now the org data for ellipse
df_ell.gui.org.sev <- data.frame() #sets up a data frame before running the function.
for(g in levels(gui.org.site.scrs$Severity)){
  df_ell.gui.org.sev <- rbind(df_ell.gui.org.sev, cbind(as.data.frame(with(gui.org.site.scrs [gui.org.site.scrs$Severity==g,],
                                                         veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2))))) ,Severity=g))
}
NMDS.mean.gui.org=aggregate(gui.org.site.scrs[ ,c("NMDS1", "NMDS2")], 
                         list(group = gui.org.site.scrs$Severity), mean)


nmds.plot.gui.org <- ggplot(gui.org.site.scrs, aes(x=NMDS1, y=NMDS2))+ #sets up the plot
  geom_point(aes(NMDS1, NMDS2, colour = factor(gui.org.site.scrs$Severity), shape = factor(gui.org.site.scrs$Sample_Date),fill = factor(gui.org.site.scrs$Severity)), size = 2)+ 
  coord_fixed()+
  theme_classic()+ 
  theme(panel.background = element_rect(fill = NA, colour = "black", size = 1, linetype = "solid"))+
  labs(colour = "Severity", shape = "Sample_Date")+ 
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10))+ geom_path(data = df_ell.gui.org.sev, aes(x = NMDS1, y = NMDS2, group = Severity,colour=Severity))+ theme(axis.text.x = element_blank(),axis.text.y = element_blank(),axis.ticks = element_blank())+scale_color_manual(values = c("cornflowerblue","chocolate","orange1","firebrick3","tomato4","black"))+ scale_fill_manual(values = c("cornflowerblue","lightgoldenrod1","orange1","firebrick3","tomato4","black"))+scale_shape_manual(values = c(21,22,23,24))+geom_segment(data = gui.org.sig.spp.scrs, aes(x = 0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd=0.4) + #add vector arrows of significant species
  ggrepel::geom_text_repel(data = gui.org.sig.spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3.5, direction = "both", segment.size = 0.25)

nmds.plot.gui.org

#joint nmds plot
ggarrange(nmds.plot.gui.org,nmds.plot.gui.min,common.legend = TRUE,ncol = 1,legend = "right")

#plot the date ellipses ----

#organic
df_ell.org.date <- data.frame() #sets up a data frame before running the function.
for(g in levels(gui.org.site.scrs$Sample_Date)){
  df_ell.org.date <- rbind(df_ell.org.date, cbind(as.data.frame(with(gui.org.site.scrs [gui.org.site.scrs$Sample_Date==g,],
                                                         veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2))))) ,Sample_Date=g))
}
NMDS.mean.org.date=aggregate(gui.org.site.scrs[ ,c("NMDS1", "NMDS2")], 
                         list(group = gui.org.site.scrs$Sample_Date), mean)


nmds.plot.org.date <- ggplot(gui.org.site.scrs, aes(x=NMDS1, y=NMDS2))+ #sets up the plot
  geom_point(aes(NMDS1, NMDS2, colour = factor(gui.org.site.scrs$Severity),fill = factor(gui.org.site.scrs$Severity), shape = factor(gui.org.site.scrs$Sample_Date)), size = 2)+
  coord_fixed()+
  theme_classic()+ 
  theme(panel.background = element_rect(fill = NA, colour = "black", size = 1, linetype = "solid"))+
  labs(colour = "Severity", shape = "Sample_Date")+ 
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10))+ geom_path(data = df_ell.org.date, aes(x = NMDS1, y = NMDS2, group = Sample_Date))+ theme(axis.text.x = element_blank(),axis.text.y = element_blank(),axis.ticks = element_blank())+scale_color_manual(values = c("cornflowerblue","chocolate","orange1","firebrick3","tomato4","black"))+ scale_fill_manual(values = c("cornflowerblue","lightgoldenrod1","orange1","firebrick3","tomato4","black"))+scale_shape_manual(values = c(21,22,23,24))+geom_segment(data = gui.org.sig.spp.scrs, aes(x = 0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd=0.4) + #add vector arrows of significant species
  ggrepel::geom_text_repel(data = gui.org.sig.spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3.5, direction = "both", segment.size = 0.25)
nmds.plot.org.date


#mineral 
df_ell.min.date <- data.frame() #sets up a data frame before running the function.
for(g in levels(gui.min.site.scrs$Sample_Date)){
  df_ell.min.date <- rbind(df_ell.min.date, cbind(as.data.frame(with(gui.min.site.scrs [gui.min.site.scrs$Sample_Date==g,],
                                                         veganCovEllipse(cov.wt(cbind(NMDS1,NMDS2),wt=rep(1/length(NMDS1),length(NMDS1)))$cov,center=c(mean(NMDS1),mean(NMDS2))))) ,Sample_Date=g))
}
NMDS.mean.min=aggregate(gui.min.site.scrs[ ,c("NMDS1", "NMDS2")], 
                         list(group = gui.min.site.scrs$Sample_Date), mean)

nmds.plot.min.date <- ggplot(gui.min.site.scrs, aes(x=NMDS1, y=NMDS2))+ #sets up the plot
  geom_point(aes(NMDS1, NMDS2, colour = factor(gui.min.site.scrs$Severity), shape = factor(gui.min.site.scrs$Sample_Date),fill = factor(gui.min.site.scrs$Severity)), size = 2)+
  coord_fixed()+
  theme_classic()+ 
  theme(panel.background = element_rect(fill = NA, colour = "black", size = 1, linetype = "solid"))+
  labs(colour = "Severity", shape = "Sample_Date")+ 
  theme(legend.position = "right", legend.text = element_text(size = 12), legend.title = element_text(size = 12), axis.text = element_text(size = 10))+ geom_path(data = df_ell.min.date, aes(x = NMDS1, y = NMDS2, group = Sample_Date))+ theme(axis.text.x = element_blank(),axis.text.y = element_blank(),axis.ticks = element_blank())+scale_color_manual(values = c("cornflowerblue","chocolate","orange1","firebrick3","tomato4","black"))+ scale_fill_manual(values = c("cornflowerblue","lightgoldenrod1","orange1","firebrick3","tomato4","black"))+scale_shape_manual(values = c(21,22,23,24))+geom_segment(data = gui.min.sig.spp.scrs, aes(x = 0, xend=NMDS1, y=0, yend=NMDS2), arrow = arrow(length = unit(0.25, "cm")), colour = "grey10", lwd=0.4) + #add vector arrows of significant species
  ggrepel::geom_text_repel(data = gui.min.sig.spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3.5, direction = "both", segment.size = 0.25)
nmds.plot.min.date

#plot together
ggarrange(nmds.plot.gui.org,nmds.plot.gui.min,nmds.plot.org.date,nmds.plot.min.date,legend = "none",ncol = 1,nrow = 2)

#code adapted from https://www.rpubs.com/RGrieger/545184
```

##PERMANOVA
```{r}
#create bray dist matrix
bray.dist.min.gui<-vegdist(psotu2veg(phylo.gui.mineral.3),method = "bray")
bray.dist.org.gui<-vegdist(psotu2veg(phylo.gui.orgeral.3),method = "bray")

#create meta.data of fall and spring data
sd.min.gui<-as.data.frame(sample_data(phylo.gui.mineral.3))
sd.org.gui<-as.data.frame(sample_data(phylo.gui.orgeral.3))
class(sd.org.gui)<-NULL
class(sd.min.gui)<-NULL
sd.org.gui<-as.data.frame(sd.org.gui)
sd.min.gui<-as.data.frame(sd.min.gui)

#test assumptions
min.disp.gui <- betadisper(bray.dist.min.gui, group = sd.min.gui$Severity, 
                      type = "centroid", bias.adjust = FALSE, sqrt.dist = FALSE)

min.disp.gui
permutest(min.disp.gui, pairwise = FALSE, permutations = 999, parallel = 1)
#gouda
org.disp.gui <- betadisper(bray.dist.org.gui, group = sd.org.gui$Severity, 
                      type = "centroid", bias.adjust = FALSE, sqrt.dist = FALSE)

org.disp.gui
permutest(org.disp.gui, pairwise = FALSE, permutations = 999, parallel = 1)
#gouda

#perform test 
adonis.min.gui<- adonis2(psotu2veg(phylo.gui.mineral.3) ~ Severity * sample_date ,data = sd.min.gui, method= "bray")
adonis.min.gui
#^seve and sample date are sig
adonis.org.gui<-adonis2(psotu2veg(phylo.gui.orgeral.3) ~ Severity * sample_date, data = sd.org.gui, method = "bray")
adonis.org.gui
#^ severe, sample date and interaction are sig 


#I want to test post hoc 
pairwise.adonis <- function(x, factor, sim.function = 'vegdist', sim.method = 'bray', p.adjust.m ='bonferroni',reduce=NULL,perm=999)
{

  co <- combn(unique(as.character(factor)),2)
  pairs <- c()
  Df <- c()
  SumsOfSqs <- c()
  F.Model <- c()
  R2 <- c()
  p.value <- c()
  
  
  for(elem in 1:ncol(co)){
    if(inherits(x, 'dist')){
      x1=as.matrix(x)[factor %in% c(as.character(co[1,elem]),as.character(co[2,elem])),
                      factor %in% c(as.character(co[1,elem]),as.character(co[2,elem]))]
    }
    
    else  (
      if (sim.function == 'daisy'){
        x1 = daisy(x[factor %in% c(co[1,elem],co[2,elem]),],metric=sim.method)
      } 
      else{x1 = vegdist(x[factor %in% c(co[1,elem],co[2,elem]),],method=sim.method)}
    )
    
    ad <- adonis(x1 ~ factor[factor %in% c(co[1,elem],co[2,elem])],
                 permutations = perm);
    pairs <- c(pairs,paste(co[1,elem],'vs',co[2,elem]));
    Df <- c(Df,ad$aov.tab[1,1])
    SumsOfSqs <- c(SumsOfSqs, ad$aov.tab[1,2])
    F.Model <- c(F.Model,ad$aov.tab[1,4]);
    R2 <- c(R2,ad$aov.tab[1,5]);
    p.value <- c(p.value,ad$aov.tab[1,6])
  }
  p.adjusted <- p.adjust(p.value,method=p.adjust.m)
  
  sig = c(rep('',length(p.adjusted)))
  sig[p.adjusted <= 0.05] <-'.'
  sig[p.adjusted <= 0.01] <-'*'
  sig[p.adjusted <= 0.001] <-'**'
  sig[p.adjusted <= 0.0001] <-'***'
  pairw.res <- data.frame(pairs,Df,SumsOfSqs,F.Model,R2,p.value,p.adjusted,sig)
  
  if(!is.null(reduce)){
    pairw.res <- subset (pairw.res, grepl(reduce,pairs))
    pairw.res$p.adjusted <- p.adjust(pairw.res$p.value,method=p.adjust.m)
    
    sig = c(rep('',length(pairw.res$p.adjusted)))
    sig[pairw.res$p.adjusted <= 0.1] <-'.'
    sig[pairw.res$p.adjusted <= 0.05] <-'*'
    sig[pairw.res$p.adjusted <= 0.01] <-'**'
    sig[pairw.res$p.adjusted <= 0.001] <-'***'
    pairw.res <- data.frame(pairw.res[,1:7],sig)
  }
  class(pairw.res) <- c("pwadonis", "data.frame")
  return(pairw.res)
} 

pairwise.sur.sev<-pairwise.adonis(bray.dist.org.gui,sd.org.gui$Severity)
is.data.frame(pairwise.sur.sev)
write_csv(pairwise.sur.sev,file="Pairwise.surface.severity.functional.csv")
pairwise.sur.sev<-pairwise.adonis(bray.dist.org.gui,sd.org.gui$Severity)
is.data.frame(pairwise.sur.sev)
write_csv(pairwise.sur.sev,file="Pairwise.surface.severity.functional.csv")
```

#create pres.abs / richness for guilds- type 4
```{r}
#turn from OTU/ASV abundance to OTU/ASV presence absence 
fall.df.prs.abs<-Funguild.fall.3[,c(2:42,44:63)]
spring.df.prs.abs<-Funguild.spring.3[,c(2:95)]

fall.df.prs.abs[fall.df.prs.abs>0]<-1
spring.df.prs.abs[spring.df.prs.abs>0]<-1

fall.df.prs.abs.3<-as.data.frame(cbind(fall.df.prs.abs[,c(1:27,31:ncol(fall.df.prs.abs))],Funguild.fall.3[,64:74]))
spring.df.prs.abs.3<-as.data.frame(cbind(spring.df.prs.abs[,c(1:37,46:ncol(spring.df.prs.abs))],Funguild.spring.3[,96:106]))

guild.df.fall.prs.abs.3<-aggregate(fall.df.prs.abs.3[,1:58], fall.df.prs.abs.3["Guild.2"],FUN=sum)
guild.df.fall.prs.abs.3<-t(guild.df.fall.prs.abs.3)
colnames(guild.df.fall.prs.abs.3)<-guild.df.fall.prs.abs.3[1,]
guild.df.fall.prs.abs.3<-as.data.frame(guild.df.fall.prs.abs.3[-1,])
guild.df.fall.prs.abs.3<-lapply(guild.df.fall.prs.abs.3,as.numeric)
guild.df.fall.prs.abs.3<-cbind(guild.df.fall.prs.abs.3,meta.data.microplots.fall)

guild.df.spring.prs.abs.3<-aggregate(spring.df.prs.abs.3[,1:86], spring.df.prs.abs.3["Guild.2"],FUN=sum)
guild.df.spring.prs.abs.3<-t(guild.df.spring.prs.abs.3)
colnames(guild.df.spring.prs.abs.3)<-guild.df.spring.prs.abs.3[1,]
guild.df.spring.prs.abs.3<-as.data.frame(guild.df.spring.prs.abs.3[-1,])
guild.df.spring.prs.abs.3<-lapply(guild.df.spring.prs.abs.3,as.numeric)
guild.df.spring.prs.abs.3<-cbind(guild.df.spring.prs.abs.3,meta.data.microplots.spring)

#merge fall and spring data sets
colnames(guild.df.spring.prs.abs.3)
colnames(guild.df.fall.prs.abs.3)

guild.df.prs.abs.3<-rbind(guild.df.fall.prs.abs.3,guild.df.spring.prs.abs.3)

```

##plot pres abs/ richness for type 4
```{r}
#seperate based on sample-type
guild.df.mineral.prs.abs.3<-dplyr::filter(guild.df.prs.abs.3, sample_type == "Mineral")
guild.df.organic.prs.abs.3<-dplyr::filter(guild.df.prs.abs.3,sample_type=="Surface")

guild.mineral.long.prs.abs.3 <- melt(guild.df.mineral.prs.abs.3[,c(1:11,14)], id.vars = "Severity", variable.name = "Guild")
guild.mineral.long.prs.abs.3$Severity<-ordered(guild.mineral.long.prs.abs.3$Severity,levels=c("Unburnt","Low","Medium","Medium-Severe","Severe","LP-Severe"))

guild.organic.long.prs.abs.3 <- melt(guild.df.organic.prs.abs.3[,c(1:11,14)], id.vars = "Severity", variable.name = "Guild")
guild.organic.long.prs.abs.3$Severity<-ordered(guild.organic.long.prs.abs.3$Severity,levels=c("Unburnt","Low","Medium","Medium-Severe","Severe","LP-Severe"))

guild.m.bar.prs.abs.3<-ggplot(guild.mineral.long.prs.abs.3, aes(x = Severity, y = value, fill = `Guild`)) + 
    geom_bar(stat = "identity")
guild.o.bar.prs.abs.3<-ggplot(guild.organic.long.prs.abs.3, aes(x = Severity, y = value, fill = `Guild`)) + 
    geom_bar(stat = "identity")

ggarrange(guild.m.bar.prs.abs.3,guild.o.bar.prs.abs.3,common.legend = TRUE)
```

##make guild groups with no combination categories 
```{r}
#5: same guild/groups as type 4 except I should remove the joint categories by adding the number of reads/species to each of the unique category----- for multivariate analysis
#example ecto/sapro = 412, ecto = 120, sapro = 400. following adjustments, no ecto/sapro, ecto =532, sapro = 812 
#new dataset
guild.df.prs.abs.4<-guild.df.prs.abs.3

#add reads from other categories
guild.df.prs.abs.4$Ectomycorrhizal<- guild.df.prs.abs.4$Ectomycorrhizal+ guild.df.prs.abs.4$`Pathotroph-Ectomycorrhizal` + guild.df.prs.abs.4$`Saprotroph-Ectomycorrhizal`

guild.df.prs.abs.4$Symbiotroph<- guild.df.prs.abs.4$Symbiotroph+guild.df.prs.abs.4$`Pathotroph-Saprotroph-Symbiotroph`+guild.df.prs.abs.4$`Pathotroph-Symbiotroph`+guild.df.prs.abs.4$`Saprotroph-Symbiotroph`

guild.df.prs.abs.4$Pathotroph<-guild.df.prs.abs.4$`Pathotroph-Ectomycorrhizal`+guild.df.prs.abs.4$`Pathotroph-Saprotroph`+guild.df.prs.abs.4$`Pathotroph-Saprotroph-Symbiotroph`+guild.df.prs.abs.4$`Pathotroph-Symbiotroph`+guild.df.prs.abs.4$Pathotroph

guild.df.prs.abs.4$Saprotroph<-guild.df.prs.abs.4$Saprotroph+guild.df.prs.abs.4$`Saprotroph-Ectomycorrhizal`+guild.df.prs.abs.4$`Pathotroph-Saprotroph`+guild.df.prs.abs.4$`Pathotroph-Saprotroph-Symbiotroph`+guild.df.prs.abs.4$`Saprotroph-Symbiotroph`

#remove combo columns
guild.df.prs.abs.4<- guild.df.prs.abs.4[,c(-4,-5,-7,-8,-9,-11)]

#write_csv(guild.df.prs.abs.4, "guild.presence.abs.oct13.2021.csv")

##repeat except with read data not richness
#new dataset
guild.df.4<-guild.df.3

#add reads from other categories
guild.df.4$E<- guild.df.4$E+ guild.df.4$`P-E` + guild.df.4$`Sp-E`

guild.df.4$Sy<- guild.df.4$Sy+guild.df.4$`P-Sp-Sy`+guild.df.4$`P-Sy`+guild.df.4$`Sp-Sy`

guild.df.4$P<-guild.df.4$`P-E`+guild.df.4$`P-Sp`+guild.df.4$`P-Sp-Sy`+guild.df.4$`P-Sy`+guild.df.4$P

guild.df.4$Sp<-guild.df.4$Sp+guild.df.4$`Sp-E`+guild.df.4$`P-Sp`+guild.df.4$`P-Sp-Sy`+guild.df.4$`Sp-Sy`

#remove combo columns
guild.df.4<- guild.df.4[,c(-1,-4,-5,-7,-8,-9,-11)]

```

#using guild.df.3 to plot relative abundnace of total reads
```{r}
##these would give an average percent of total reads per severity level in each functional category - then create four plots for over time 
# I kinda have to do for this classification type with the combination categories because by adding reads to each group it would through offf the percent of total reads 
#kind in mind that not all reads were classified into functional guilds 

#first take away LP severe
guild.df.3<-dplyr::filter(guild.df.3, Severity != "LP-Severe")

#try all months in 
guild.df.3.propor<-cbind(guild.df.3[,1:11]/5239586,guild.df.3[,12:14])
guild.df.3.propor.melt<-melt(guild.df.3.propor)

ggplot(guild.df.3.propor.melt, aes(x = variable, y = value, color=Severity)) +geom_boxplot(position=position_dodge(0.6), size = 2)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Functional group", y = "test") + 
    theme_classic()

ggplot(guild.df.3.propor.melt, aes(x = Severity, y = value, color=variable)) +geom_boxplot(position=position_dodge(0.6), size = 2)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Functional group", y = "test") + 
    theme_classic()

#lets try relative to the sample total that are matched to a fungal guild... 
guild.df.3$totalreads<-rowSums(guild.df.3[,1:11]) # create row of sample totals 
guild.df.3.reltosample<-cbind(guild.df.3[,1:11]/guild.df.3$totalreads,guild.df.3[,12:14]) # dvided each by total
guild.df.3.reltosample<-guild.df.3.reltosample[,2:14]#remove arbusular so I dont have to visualize
guild.df.3.reltosample.melt<-melt(guild.df.3.reltosample)

ggplot(guild.df.3.reltosample.melt, aes(x = variable, y = value, color=Severity)) +geom_boxplot(position=position_dodge(0.6), size = 2)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Functional group", y = "test") + 
    theme_classic()

ggplot(guild.df.3.reltosample.melt, aes(x = Severity, y = value, color=variable)) +geom_boxplot(position=position_dodge(0.6), size = 2)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Functional group", y = "test") + 
    theme_classic()


#lets compare with the condensed categories 
guild.df.4$totalreads<-rowSums(guild.df.4[,1:4]) # create row of sample totals 
guild.df.4.reltosample<-cbind(guild.df.4[,1:4]/guild.df.4$totalreads,guild.df.4[,5:7]) # dvided each by total
guild.df.4.reltosample.melt<-melt(guild.df.4.reltosample)

ggplot(guild.df.4.reltosample.melt, aes(x = variable, y = value, color=Severity)) +geom_boxplot(position=position_dodge(0.6), size = 1)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Functional group", y = "test") + 
    theme_classic()

ggplot(guild.df.4.reltosample.melt, aes(x = Severity, y = value, color=variable)) +geom_boxplot(position=position_dodge(0.6), size = 1)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Functional group", y = "test") + 
    theme_classic()

#split into months

guild.df.3.sept<-dplyr::filter(guild.df.3, sample_date == "September")
guild.df.3.sept<-cbind(guild.df.3.sept[,1:11]/1084166,guild.df.3.sept[,12:14])
guild.df.3.sept.melt<-melt(guild.df.3.sept)
guild.df.3.sept$totalreads<-rowSums(guild.df.3.sept[,1:11]) # create row of sample totals 
guild.df.3.reltosample.s<-cbind(guild.df.3.sept[,1:11]/guild.df.3.sept$totalreads,guild.df.3.sept[,12:14]) # dvided each by total
guild.df.3.reltosample.melt.s<-melt(guild.df.3.reltosample.s)
guild.df.3.reltosample.melt.s.con<-melt(guild.df.3.reltosample.s[,c(2,5,6,7,10,12,13,14)])


guild.df.3.oct<-dplyr::filter(guild.df.3, sample_date == "October")
guild.df.3.oct<-cbind(guild.df.3.sept[,1:11]/1339069,guild.df.3.oct[,12:14])
guild.df.3.oct.melt<-melt(guild.df.3.oct)
guild.df.3.oct$totalreads<-rowSums(guild.df.3.oct[,1:11]) # create row of sample totals 
guild.df.3.reltosample.o<-cbind(guild.df.3.oct[,1:11]/guild.df.3.oct$totalreads,guild.df.3.oct[,12:14]) # dvided each by total
guild.df.3.reltosample.melt.o<-melt(guild.df.3.reltosample.o)
guild.df.3.reltosample.melt.o.con<-melt(guild.df.3.reltosample.o[,c(2,5,6,7,10,12,13,14)])

guild.df.3.may<-dplyr::filter(guild.df.3, sample_date == "May")
guild.df.3.may$totalreads<-rowSums(guild.df.3.may[,1:11]) # create row of sample totals 
guild.df.3.reltosample.m<-cbind(guild.df.3.may[,1:11]/guild.df.3.may$totalreads,guild.df.3.may[,12:14]) # dvided each by total
guild.df.3.reltosample.melt.m<-melt(guild.df.3.reltosample.m)
guild.df.3.reltosample.melt.m.con<-melt(guild.df.3.reltosample.m[,c(2,5,6,7,10,12,13,14)])

guild.df.3.june<-dplyr::filter(guild.df.3, sample_date == "June")
guild.df.3.june$totalreads<-rowSums(guild.df.3.june[,1:11]) # create row of sample totals 
guild.df.3.reltosample.j<-cbind(guild.df.3.june[,1:11]/guild.df.3.june$totalreads,guild.df.3.june[,12:14]) # dvided each by total
guild.df.3.reltosample.melt.j<-melt(guild.df.3.reltosample.j)
guild.df.3.reltosample.melt.j.con<-melt(guild.df.3.reltosample.j[,c(2,5,6,7,10,12,13,14)])

#all months back together
melt.guild.rel.con<-rbind(guild.df.3.reltosample.melt.s.con,guild.df.3.reltosample.melt.o.con,guild.df.3.reltosample.melt.m.con,guild.df.3.reltosample.melt.j.con)
ggplot(melt.guild.rel.con[melt.guild.rel.con$sample_type == "Mineral",], aes(x = variable, y = value, color=Severity,shape=sample_type)) +geom_boxplot(position=position_dodge(0.6))+
    labs(x = "Functional group", y = "Proportion of assigned reads") + 
    theme_classic()
ggplot(melt.guild.rel.con[melt.guild.rel.con$sample_type == "Surface",], aes(x = variable, y = value, color=Severity,shape=sample_type)) +geom_boxplot(position=position_dodge(0.6))+
    labs(x = "Functional group", y = "Proportion of assigned reads") + 
    theme_classic()

#sept
ggplot(guild.df.3.sept.melt, aes(x = variable, y = value, color=Severity)) +geom_jitter(position=position_dodge(0.6), size = 2,stroke=2)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Functional group", y = "test") + 
    theme_classic()
ggplot(guild.df.3.reltosample.melt.s.con, aes(x = variable, y = value, color=Severity)) +geom_boxplot(position=position_dodge(0.6), size = 1)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Functional group", y = "test") + 
    theme_classic()

ggplot(guild.df.3.reltosample.melt.s.con, aes(x = Severity, y = value, color=variable)) +geom_boxplot(position=position_dodge(0.6), size = 1)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
ggplot(guild.df.3.reltosample.melt.s.con, aes(x = Severity, y = value, color=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
ggplot(guild.df.3.reltosample.melt.s.con[guild.df.3.reltosample.melt.s.con$sample_type == "Mineral",], aes(colour = Severity, y = value, x=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
 ggplot(guild.df.3.reltosample.melt.s.con[guild.df.3.reltosample.melt.s.con$sample_type == "Surface",], aes(colour = Severity, y = value, x=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
#oct
ggplot(guild.df.3.reltosample.melt.o.con, aes(colour = Severity, y = value, x=variable)) +geom_boxplot(position=position_dodge(0.6), size = 1)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
ggplot(guild.df.3.reltosample.melt.o.con, aes(x = Severity, y = value, color=variable)) +geom_boxplot(position=position_dodge(0.6), size = 1)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
ggplot(guild.df.3.reltosample.melt.o.con, aes(x = Severity, y = value, color=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
ggplot(guild.df.3.reltosample.melt.o.con[guild.df.3.reltosample.melt.o.con$sample_type == "Mineral",], aes(colour = Severity, y = value, x=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
 ggplot(guild.df.3.reltosample.melt.o.con[guild.df.3.reltosample.melt.o.con$sample_type == "Surface",], aes(colour = Severity, y = value, x=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
#may
ggplot(guild.df.3.reltosample.melt.m.con, aes(x = Severity, y = value, color=variable)) +geom_boxplot(position=position_dodge(0.6), size = 1)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
ggplot(guild.df.3.reltosample.melt.m.con, aes(x = Severity, y = value, color=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
ggplot(guild.df.3.reltosample.melt.m.con[guild.df.3.reltosample.melt.m.con$sample_type == "Mineral",], aes(colour = Severity, y = value, x=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
 ggplot(guild.df.3.reltosample.melt.m.con[guild.df.3.reltosample.melt.m.con$sample_type == "Surface",], aes(colour = Severity, y = value, x=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
#june
ggplot(guild.df.3.reltosample.melt.j.con, aes(x = Severity, y = value, color=variable)) +geom_boxplot(position=position_dodge(0.6), size = 1)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
ggplot(guild.df.3.reltosample.melt.j.con, aes(x = Severity, y = value, color=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
ggplot(guild.df.3.reltosample.melt.j.con[guild.df.3.reltosample.melt.j.con$sample_type == "Mineral",], aes(x = Severity, y = value, color=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()
 ggplot(guild.df.3.reltosample.melt.j.con[guild.df.3.reltosample.melt.j.con$sample_type == "Surface",], aes(x = Severity, y = value, color=variable,shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(2)) +
    labs(x = "Severity", y = "Proportion of assigned reads") + 
    theme_classic()

```

#check assumptions and check data for testing differences between mean realtive abundance
```{r}
qqnorm(guild.df.3.reltosample.melt.s.con$value)
hist(guild.df.3.reltosample.melt.s.con)
qqnorm(guild.df.3.reltosample.melt.o.con$value)
hist(guild.df.3.reltosample.melt.o.con)
qqnorm(guild.df.3.reltosample.melt.m.con$value)
hist(guild.df.3.reltosample.melt.m.con)
qqnorm(guild.df.3.reltosample.melt.j.con$value)
hist(guild.df.3.reltosample.melt.j.con)

#I believe the logit transformation is the best for proportion data?
g.3.melt.s.con.logit<-cbind(guild.df.3.reltosample.melt.s.con,car::logit(guild.df.3.reltosample.melt.s.con$value))
#The warning occurs because it is adjusting when there are zeros in the data 
qqnorm(g.3.melt.s.con.logit[g.3.melt.s.con.logit$variable == "E",]$`car::logit(guild.df.3.reltosample.melt.s.con$value)`)
#not bad
qqnorm(g.3.melt.s.con.logit[g.3.melt.s.con.logit$variable == "P",]$`car::logit(guild.df.3.reltosample.melt.s.con$value)`)
#too zero dominanted
qqnorm(g.3.melt.s.con.logit[g.3.melt.s.con.logit$variable == "Sp",]$`car::logit(guild.df.3.reltosample.melt.s.con$value)`)
#not bad
qqnorm(g.3.melt.s.con.logit[g.3.melt.s.con.logit$variable == "Sp-E",]$`car::logit(guild.df.3.reltosample.melt.s.con$value)`)
#a little rough
qqnorm(g.3.melt.s.con.logit[g.3.melt.s.con.logit$variable == "P-Sp",]$`car::logit(guild.df.3.reltosample.melt.s.con$value)`)
#also rough


## or if I use kruskal wallis I do not need to meet assumptions of normality --> can not use multiple factors
kruskal.test(guild.df.3.reltosample.melt.s.con[variable == "E",5]~guild.df.3.reltosample.melt.s.con[variable == "E",]$Severity,data = guild.df.3.reltosample.melt.s.con)
#^ this is an example of september ecto by severity - both sample layers inlcuded... 
```


##create GLM models for "richness" of type 5 without LP-Severe 
```{r}
#removce LP-SEvere from dataset
guild.df.prs.abs.lp<-dplyr::filter(guild.df.prs.abs.4, Severity != "LP-Severe")

#visualize 
ggplot(guild.df.prs.abs.lp, aes(x = Severity, y = Ectomycorrhizal, color=sample_date, shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 2,stroke=2)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Ectomycorrhizal guild richness") + 
    theme_classic()+scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))
ggplot(guild.df.prs.abs.lp, aes(x = Severity, y = Pathotroph, color=sample_date, shape=sample_type)) + 
    geom_jitter(position=position_dodge(0.6), size = 2,stroke=2)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Pathotrophic guild richness") + 
    theme_classic()+scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))
ggplot(guild.df.prs.abs.lp.omitted, aes(x = Severity, y = Saprotroph, color=sample_date, shape=sample_type)) +
    geom_jitter(position=position_dodge(0.6), size = 2,stroke=2)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Saprotrophic guild richness") + 
    theme_classic()+scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))
ggplot(guild.df.prs.abs.lp, aes(x = Severity, y = Symbiotroph, color=sample_date, shape=sample_type)) +
    geom_jitter(position=position_dodge(0.6), size = 2,stroke=2)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Symbiotrophic guild richness") + 
    theme_classic()+scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))
ggplot(guild.df.prs.abs.lp, aes(x = Severity, y = `Arbusular/Orchid Mycorrhizal`, color=sample_date, shape=sample_type)) +
    geom_jitter(position=position_dodge(0.6), size = 2,stroke=2)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Abuscular/Orchid Mycorrhizal guild richness") + 
    theme_classic()+scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))

#test loess curve?
ggplot(guild.df.prs.abs.lp, aes(x = Severity, y = Ectomycorrhizal)) + 
    geom_point(size = 2, col = "firebrick") + 
    geom_smooth(aes(group=1),method = "loess", size = 1, col = "black", span = 0.8) +
    theme_classic()


#generalized linear models with possion/quasi distribution for count data 
set.seed(43)

#symbio.rich.lp<-glm(Symbiotroph~Severity*sample_date*sample_type,family = poisson(link = "log"),data = guild.df.prs.abs.lp)
summary(symbio.rich.lp)
anova(symbio.rich.lp)
#test with quasi to see if dispersion is okay 
z.symbio<-glm(Symbiotroph~Severity*sample_date*sample_type,family = quasipoisson(link = "log"),data = guild.df.prs.abs.lp)
summary(z.symbio)
anova(z.symbio, test = "F")
emmeans(z.symbio,specs = pairwise ~Severity,data=guild.df.prs.abs.lp,type="response")
emmeans(z.symbio,specs = pairwise~Severity*sample_date,data=guild.df.prs.abs.lp,type="response")
emmeans(z.symbio,specs = pairwise~Severity*sample_type,data=guild.df.prs.abs.lp,type="response")%>% summary(infer=TRUE)
plot(resid(z.symbio))
#2.5 

outlierTest(z.symbio)

#ecto.rich<-glm(Ectomycorrhizal~Severity*sample_date*sample_type,family = poisson(link = "log"),data = guild.df.prs.abs.lp)
summary(ecto.rich)
anova(ecto.rich)
z.ecto<-glm(Ectomycorrhizal~Severity*sample_date*sample_type,family = quasipoisson(link = "log"),data = guild.df.prs.abs.lp)
emmeans(z.ecto,specs = pairwise ~Severity,data=guild.df.prs.abs.lp,type="response")
emmeans(z.ecto, specs = pairwise ~sample_date,data=guild.df.prs.abs.lp,type="response")
emmeans(z.ecto, specs = pairwise ~sample_type,data=guild.df.prs.abs.lp,type="response")
summary(z.ecto)
#1.9
anova(z.ecto,test="F")

outlierTest(z.ecto)

#patho.rich<-glm(Pathotroph~Severity*sample_date*sample_type,family = poisson(link = "log"),data = guild.df.prs.abs.lp)
summary(patho.rich)
anova(patho.rich)
z.patho<-glm(Pathotroph~Severity*sample_date*sample_type,family = quasipoisson(link = "log"),data = guild.df.prs.abs.lp)
emmeans(z.patho,specs = pairwise ~Severity,data=guild.df.prs.abs.lp,type="response")
emmeans(z.patho, specs = pairwise ~sample_date,data=guild.df.prs.abs.lp,type="response")
emmeans(z.patho, specs = pairwise ~sample_type,data=guild.df.prs.abs.lp,type="response")
emmeans(z.patho, specs = pairwise ~sample_date*sample_type,data=guild.df.prs.abs.lp,type="response")
emmeans(z.patho, specs = pairwise ~Severity*sample_date,data=guild.df.prs.abs.lp,type="response")
summary(z.patho)
#2.28
anova(z.patho,test = "F")

outlierTest(z.patho)

#sapro.rich<-glm(Saprotroph~Severity*sample_date*sample_type,family = poisson(link = "log"),data = guild.df.prs.abs.lp)
#summary(sapro.rich)
#anova(sapro.rich)
#z.sapro<-glm(Saprotroph~Severity*sample_date*sample_type,family = quasipoisson(link = "log"),data = guild.df.prs.abs.lp)
#summary(z.sapro)
#4.4
#anova(z.sapro,test="F")

outlierTest(z.sapro)
#O16G needs to be removed 
guild.df.prs.abs.lp.omitted<-guild.df.prs.abs.lp[-110,]
z.sapro<-glm(Saprotroph~Severity*sample_date*sample_type,family = quasipoisson(link = "log"),data = guild.df.prs.abs.lp.omitted)
emmeans(z.sapro,specs = pairwise ~Severity,data=guild.df.prs.abs.lp.omitted,type="response")
emmeans(z.sapro, specs = pairwise ~sample_date,data=guild.df.prs.abs.lp.omitted,type="response")
emmeans(z.sapro, specs = pairwise ~Severity*sample_date,data=guild.df.prs.abs.lp.omitted,type="response")
emmeans(z.sapro, specs = pairwise ~sample_date*sample_type,data=guild.df.prs.abs.lp.omitted,type="response")
summary(z.sapro)
#3.3
anova(z.sapro,test="F")


# not testing 
#abus.orch.rich.lp<-glm(`Arbusular/Orchid Mycorrhizal`~Severity*sample_date*sample_type,family = poisson(link = "log"),data = guild.df.prs.abs.lp)
#summary(abus.orch.rich.lp)
#anova(abus.orch.rich.lp, test = "Chisq")
#z.abus.orch<-glm(`Arbusular/Orchid Mycorrhizal`~Severity*sample_date*sample_type,family = quasipoisson(link = "log"),data = guild.df.prs.abs.lp)
#summary(z.abus.orch)
```

##plot means onto functional guild figures 
```{r}
#ecto subplots ----
##ecto -date
ggplot(guild.df.prs.abs.lp) + #create base plot
  geom_point(aes(x = Severity, y = Ectomycorrhizal,color=sample_date,shape=sample_type),position=position_dodge(0.6),size=2,stroke=2)+ #add points
  labs(x = "Severity", y = "Ectomycorrhizal guild richness") + #add axis labels
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+ #manually colour points
  scale_shape_manual(values = c(1,2))+ #manually provide open point shapes
  theme_classic()+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+ #place axis on the right hand side
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Ectomycorrhizal,color=sample_date,group=sample_date,shape=sample_type),fun.data="mean_se",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+ #add the se of the mean 
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Ectomycorrhizal,color=sample_date,group=sample_date,shape=sample_type),fun ="mean",geom = "point", position = position_dodge(0.6),size=2,shape=8) # add the mean points 

pointshape<-c(rep(16,5),rep(17,5)) #set point shape for means 
#ecto - layer
ggplot(guild.df.prs.abs.lp) +
  geom_point(aes(x = Severity, y = Ectomycorrhizal,shape=sample_type,color=sample_date),position=position_dodge(0.6),size=2,stroke=2)+
  labs(x = "Severity", y = "Ectomycorrhizal guild richness") +
  theme_classic()+
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+
  scale_shape_manual(values = c(1,2))+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Ectomycorrhizal,shape=sample_type,group=sample_type,color=sample_date),fun.data="mean_cl_normal",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Ectomycorrhizal,shape=sample_type,group=sample_type),shape=pointshape,fun ="mean",geom = "point", position = position_dodge(0.6),size=3)


#ecto- only sev 
ggplot(guild.df.prs.abs.lp) +
  geom_point(aes(x = Severity, y = Ectomycorrhizal,shape=sample_type,group=Severity,color=sample_date),position=position_jitter(0.2),size=2,stroke=2)+
  labs(x = "Severity", y = "Ectomycorrhizal guild richness") +
  theme_classic()+
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+
  scale_shape_manual(values = c(1,2))+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Ectomycorrhizal,shape=sample_type,group=Severity,color=sample_date),fun.data="mean_se",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Ectomycorrhizal,shape=sample_type,group=Severity,color=sample_date),fun ="mean",geom = "point", position = position_dodge(0.6),size=2,shape=8)

#patho subplots ----
##patho -date
ggplot(guild.df.prs.abs.lp) + #create base plot
  geom_point(aes(x = Severity, y = Pathotroph,color=sample_date,shape=sample_type),position=position_dodge(0.6),size=2,stroke=2)+ #add points
  labs(x = "Severity", y = "Pathotroph guild richness") + #add axis labels
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+ #manually colour points
  scale_shape_manual(values = c(1,2))+ #manually provide open point shapes
  theme_classic()+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+ #place axis on the right hand side
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Pathotroph,color=sample_date,group=sample_date,shape=sample_type),fun.data="mean_se",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+ #add the se of the mean 
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Pathotroph,color=sample_date,group=sample_date,shape=sample_type),fun ="mean",geom = "point", position = position_dodge(0.6),size=2,shape=8) # add the mean points 

#patho - layer
ggplot(guild.df.prs.abs.lp) +
  geom_point(aes(x = Severity, y = Pathotroph,shape=sample_type,color=sample_date),position=position_dodge(0.6),size=2,stroke=2)+
  labs(x = "Severity", y = "Pathotroph guild richness") +
  theme_classic()+
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+
  scale_shape_manual(values = c(1,2))+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Pathotroph,shape=sample_type,group=sample_type,color=sample_date),fun.data="mean_cl_normal",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Pathotroph,shape=sample_type,group=sample_type),shape=pointshape,fun ="mean",geom = "point", position = position_dodge(0.6),size=3)

#patho - date vs layer
ggplot(guild.df.prs.abs.lp) +
  geom_point(aes(x = sample_type, y = Pathotroph,color=sample_date),position=position_jitterdodge(dodge.width = 0.6, jitter.width = 0.3),size=2,stroke=2)+
  labs(x = "Layer", y = "Pathotroph guild richness") +
  theme_classic()+
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = sample_type, y = Pathotroph,color=sample_date),fun.data="mean_cl_normal",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = sample_type, y = Pathotroph,group=sample_date,colour=sample_date),fun ="mean",geom = "point", position = position_dodge(0.6),size=3,shape=8)

#patho- only sev 
ggplot(guild.df.prs.abs.lp) +
  geom_point(aes(x = Severity, y = Pathotroph,shape=sample_type,group=Severity,color=sample_date),position=position_jitter(0.2),size=2,stroke=2)+
  labs(x = "Severity", y = "Pathotroph guild richness") +
  theme_classic()+
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+
  scale_shape_manual(values = c(1,2))+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Pathotroph,shape=sample_type,group=Severity,color=sample_date),fun.data="mean_se",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Pathotroph,shape=sample_type,group=Severity,color=sample_date),fun ="mean",geom = "point", position = position_dodge(0.6),size=2,shape=8)

#sapro subplots ----
##sapro -date
ggplot(guild.df.prs.abs.lp.omitted) + #create base plot
  geom_point(aes(x = Severity, y = Saprotroph,color=sample_date,shape=sample_type),position=position_jitterdodge(dodge.width = 0.6, jitter.width = 0.3),size=2,stroke=2)+ #add points
  labs(x = "Severity", y = "Saprotroph guild richness") + #add axis labels
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+ #manually colour points
  scale_shape_manual(values = c(1,2))+ #manually provide open point shapes
  theme_classic()+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+ #place axis on the right hand side
  stat_summary_bin(data= guild.df.prs.abs.lp.omitted ,aes(x = Severity, y = Saprotroph,color=sample_date,group=sample_date,shape=sample_type),fun.data="mean_se",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+ #add the se of the mean 
  stat_summary_bin(data= guild.df.prs.abs.lp.omitted ,aes(x = Severity, y = Saprotroph,color=sample_date,group=sample_date,shape=sample_type),fun ="mean",geom = "point", position = position_dodge(0.6),size=2,shape=8) # add the mean points 

#sapro - layer
ggplot(guild.df.prs.abs.lp.omitted) +
  geom_point(aes(x = Severity, y = Saprotroph,shape=sample_type,color=sample_date),position=position_jitterdodge(dodge.width = 0.6, jitter.width = 0.3),size=2,stroke=2)+
  labs(x = "Severity", y = "Saprotroph guild richness") +
  theme_classic()+
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+
  scale_shape_manual(values = c(1,2))+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+
  stat_summary_bin(data= guild.df.prs.abs.lp.omitted ,aes(x = Severity, y = Saprotroph,shape=sample_type,group=sample_type,color=sample_date),fun.data="mean_cl_normal",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+
  stat_summary_bin(data= guild.df.prs.abs.lp.omitted ,aes(x = Severity, y = Saprotroph,shape=sample_type,group=sample_type),shape=pointshape,fun ="mean",geom = "point", position = position_dodge(0.6),size=3)

#sapro - date vs layer 
ggplot(guild.df.prs.abs.lp.omitted) +
  geom_point(aes(x = sample_type, y = Saprotroph,color=sample_date),position=position_jitterdodge(dodge.width = 0.6, jitter.width = 0.3),size=2,stroke=2)+
  labs(x = "Layer", y = "Saprotroph guild richness") +
  theme_classic()+
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+
  stat_summary_bin(data= guild.df.prs.abs.lp.omitted ,aes(x = sample_type, y = Saprotroph,color=sample_date),fun.data="mean_cl_normal",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+
  stat_summary_bin(data= guild.df.prs.abs.lp.omitted ,aes(x = sample_type, y = Saprotroph,group=sample_date,colour=sample_date),fun ="mean",geom = "point", position = position_dodge(0.6),size=3,shape=8)

#sapro- only sev 
ggplot(guild.df.prs.abs.lp.omitted) +
  geom_point(aes(x = Severity, y = Saprotroph,shape=sample_type,group=Severity,color=sample_date),position=position_jitter(0.2),size=2,stroke=2)+
  labs(x = "Severity", y = "Saprotroph guild richness") +
  theme_classic()+
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+
  scale_shape_manual(values = c(1,2))+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+
  stat_summary_bin(data= guild.df.prs.abs.lp.omitted ,aes(x = Severity, y = Saprotroph,group=Severity,color=sample_date),fun.data="mean_se",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+
  stat_summary_bin(data= guild.df.prs.abs.lp.omitted ,aes(x = Severity, y = Saprotroph,group=Severity,color=sample_date),fun ="mean",geom = "point", position = position_dodge(0.6),size=2,shape=8)

#symbio subplots ----
##symbio -date
ggplot(guild.df.prs.abs.lp) + #create base plot
  geom_point(aes(x = Severity, y = Symbiotroph,color=sample_date,shape=sample_type),position=position_dodge(0.6),size=2,stroke=2)+ #add points
  labs(x = "Severity", y = "Symbiotroph guild richness") + #add axis labels
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+ #manually colour points
  scale_shape_manual(values = c(1,2))+ #manually provide open point shapes
  theme_classic()+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+ #place axis on the right hand side
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Symbiotroph,color=sample_date,group=sample_date,shape=sample_type),fun.data="mean_se",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+ #add the se of the mean 
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Symbiotroph,color=sample_date,group=sample_date,shape=sample_type),fun ="mean",geom = "point", position = position_dodge(0.6),size=2,shape=8) # add the mean points 

#symbio - layer
ggplot(guild.df.prs.abs.lp) +
  geom_point(aes(x = Severity, y = Symbiotroph,shape=sample_type,color=sample_date),position=position_dodge(0.6),size=2,stroke=2)+
  labs(x = "Severity", y = "Symbiotroph guild richness") +
  theme_classic()+
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+
  scale_shape_manual(values = c(1,2))+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Symbiotroph,shape=sample_type,group=sample_type,color=sample_date),fun.data="mean_cl_normal",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Symbiotroph,shape=sample_type,group=sample_type),shape=pointshape,fun ="mean",geom = "point", position = position_dodge(0.6),size=3)

#symbio- only sev 
ggplot(guild.df.prs.abs.lp) +
  geom_point(aes(x = Severity, y = Symbiotroph,shape=sample_type,group=Severity,color=sample_date),position=position_jitter(0.2),size=2,stroke=2)+
  labs(x = "Severity", y = "Symbiotroph guild richness") +
  theme_classic()+
  scale_color_manual(values = c("sienna2","sienna4","mediumaquamarine","blue4"))+
  scale_shape_manual(values = c(1,2))+
  theme(legend.position = "right",legend.title = element_blank(),axis.text = element_text(size = 13))+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Symbiotroph,shape=sample_type,group=Severity,color=sample_date),fun.data="mean_se",fun.args = list(mult=1), geom="errorbar",width=0.1, position = position_dodge(0.6),size=0.5)+
  stat_summary_bin(data= guild.df.prs.abs.lp ,aes(x = Severity, y = Symbiotroph,shape=sample_type,group=Severity,color=sample_date),fun ="mean",geom = "point", position = position_dodge(0.6),size=2,shape=8)
```

#unused lm models 
```{r}
##create LM models for "richness" of type 5 
#visualize 
ggplot(guild.df.prs.abs.4, aes(x = Severity, y = sqrt(Ectomycorrhizal), color=sample_date, shape=sample_type)) +geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "sqrt(Ectomycorrhizal guild richness)") + 
    theme_classic()+scale_color_manual(values = c("sienna2","sienna4","lightskyblue","blue4"))
ggplot(guild.df.prs.abs.4, aes(x = Severity, y = sqrt(Pathotroph), color=sample_date, shape=sample_type)) +
    geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "sqrt(Pathotroph guild richness)") + 
    theme_classic()+scale_color_manual(values = c("sienna2","sienna4","lightskyblue","blue4"))
ggplot(guild.df.prs.abs.4, aes(x = Severity, y = sqrt(Saprotroph), color=sample_date, shape=sample_type)) +
    geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "sqrt(Saprotroph guild richness)") + 
    theme_classic()+scale_color_manual(values = c("sienna2","sienna4","lightskyblue","blue4"))
ggplot(guild.df.prs.abs.4, aes(x = Severity, y = sqrt(Symbiotroph), color=sample_date, shape=sample_type)) +
    geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "sqrt(Symbiotroph guild richness)") + 
    theme_classic()+scale_color_manual(values = c("sienna2","sienna4","lightskyblue","blue4"))
ggplot(guild.df.prs.abs.4, aes(x = Severity, y = `Arbusular/Orchid Mycorrhizal`, color=sample_date, shape=sample_type)) +
    geom_jitter(position=position_dodge(0.6), size = 3)+scale_shape_manual(values=c(1, 2)) +
    labs(x = "Severity", y = "Abuscular/Orchid Mycorrhizal guild richness") + 
    theme_classic()+scale_color_manual(values = c("sienna2","sienna4","lightskyblue","blue4"))


#normality
hist(guild.df.prs.abs.4$`Arbusular/Orchid Mycorrhizal`)# not normal - log or sqrt does not work to fix
hist(sqrt(guild.df.prs.abs.4$Ectomycorrhizal))
hist(sqrt(guild.df.prs.abs.4$Symbiotroph))
hist(sqrt(guild.df.prs.abs.4$Pathotroph))
hist(sqrt(guild.df.prs.abs.4$Saprotroph))


leveneTest(Saprotroph~Severity, guild.df.prs.abs.4)
leveneTest(Pathotroph~Severity, guild.df.prs.abs.4)
leveneTest(sqrt(Symbiotroph)~Severity, guild.df.prs.abs.4)
leveneTest(sqrt(Ectomycorrhizal)~Severity, guild.df.prs.abs.4)
leveneTest(sqrt(`Arbusular/Orchid Mycorrhizal`)~Severity, guild.df.prs.abs.4)#close but not good

leveneTest(Saprotroph~sample_date, guild.df.prs.abs.4)
leveneTest(sqrt(Pathotroph)~sample_date, guild.df.prs.abs.4)
leveneTest(Symbiotroph~sample_date, guild.df.prs.abs.4)
leveneTest(Ectomycorrhizal~sample_date, guild.df.prs.abs.4)
leveneTest(sqrt(`Arbusular/Orchid Mycorrhizal`)~sample_date, guild.df.prs.abs.4)#close but not good

leveneTest(sqrt(Saprotroph)~sample_type, guild.df.prs.abs.4)#not good - but looking at the variance of residuals things are okay
leveneTest(sqrt(Pathotroph)~sample_type, guild.df.prs.abs.4)#not good - but looking at the variance of residuals things are okay
leveneTest(Symbiotroph~sample_type, guild.df.prs.abs.4)
leveneTest(sqrt(Ectomycorrhizal)~sample_type, guild.df.prs.abs.4)
leveneTest(sqrt(`Arbusular/Orchid Mycorrhizal`)~sample_type, guild.df.prs.abs.4)#not good

#trophic - symbiotroph - mineral
set.seed(43)

symbio.rich<-lm(sqrt(Symbiotroph)~Severity*sample_date*sample_type,data = guild.df.prs.abs.4)
plot(symbio.rich)
summary(symbio.rich)
anova(symbio.rich)

ecto.rich<-lm(sqrt(Ectomycorrhizal)~Severity*sample_date*sample_type,data = guild.df.prs.abs.4)
plot(ecto.rich)
summary(ecto.rich)
anova(ecto.rich)

patho.rich<-lm(sqrt(Pathotroph)~Severity*sample_date*sample_type,data = guild.df.prs.abs.4)
plot(patho.rich)
summary(patho.rich)
anova(patho.rich)

sapro.rich<-lm(sqrt(Saprotroph)~Severity*sample_date*sample_type,data = guild.df.prs.abs.4)
plot(sapro.rich)
summary(sapro.rich)
anova(sapro.rich)

##could not be transformed to fit the assumptions
abus.orch.rich<-lm(`Arbusular/Orchid Mycorrhizal`~Severity*sample_date*sample_type,data = guild.df.prs.abs.4)
summary(abus.orch.rich)
anova(abus.orch.rich)
```
